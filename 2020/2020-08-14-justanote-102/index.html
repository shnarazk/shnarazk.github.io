<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>JaNG version 1.0.2</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">import from GitHub Gist</h1><p>このブログの静的サイトジェネレータ（名前はまだない。とりあえず'JaNG', <em>Just-A-Note Generator</em> にしておきます）をバージョン1.0.2に更新しました。変更点はgithub.comに作ったgistが取り込めるようになったこと。<p><a href=https://observablehq.com/>Observable</a>が（結構）簡単に取り込めたので、1時間程度でできるかと思ったら数日がかりになってしまいました。ChangeLog代わりに苦労した点を残しておきます。<ul><li>githubが埋め込み用に提供するのはjavascriptまたはjson形式。ちょっとjavascriptは置いといてjsonを使う方向で計画。<li>ところがjsonを読み込もうとすると <code>Cross-Access-Allow-Origin</code> の制約に引っかかってデータがとって来れない。手動でリロードを掛けて、サーバー側のレンダリングされたページを持ってくれば表示はできるようにしてみたけど、それはどう考えてもかっこ悪い。<li>サーバに最初にデータを揃えて静的サイトの生成を始めるというのがどう考えても自然なので、asyncDataなのかfetchなのか、どこに書けばベストなのか、他（下）の問題も解決しながら、調べて実験して、結局 <code>nuxtServerInit</code>　をストアに追加しました。（追加するのも一苦労。actionsの中に書くのね。）この関数は最終的にcommitでstoreのデータを更新すればよいと。</ul><pre class=language-js data-lang=js style=background:#fff;color:#323232><code class=language-js data-lang=js><span style=font-style:italic;color:#969896>// store/index.js
</span><span style=font-weight:700;color:#a71d5d>export const </span><span style=color:#0086b3>actions </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>  </span><span style=font-weight:700;color:#a71d5d>async </span><span style=font-weight:700;color:#795da3>nuxtServerInit</span><span>({ commit }) {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>...
</span><span>    </span><span style=font-weight:700;color:#795da3>commit</span><span>(</span><span style=color:#183691>'mutations'</span><span>, </span><span style=font-weight:700;color:#a71d5d>...</span><span>)
</span><span>  },
</span></code></pre><ul><li><code>forEach</code> で呼び出す関数が <code>async</code> にできないことを理解するのに一苦労（まあ、<code>nuxtServerInit</code>の先頭に<code>async</code>を置きながら、forEachの無名関数にもおかなくていいのか <strong>うっすらと</strong> 疑問は感じてた）。 for文に書き直して、レンダリングが始まる前に全てのエントリーのデータを持って来れるようになったのでデータ取得問題がやっと解決。</ul><pre class=language-js data-lang=js style=background:#fff;color:#323232><code class=language-js data-lang=js><span style=font-style:italic;color:#969896>// store/index.js
</span><span style=font-weight:700;color:#a71d5d>export const </span><span style=color:#0086b3>actions </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>  </span><span style=font-weight:700;color:#a71d5d>async </span><span style=font-weight:700;color:#795da3>nuxtServerInit</span><span>({ commit }) {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>const </span><span style=color:#0086b3>arr </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#0086b3>Object</span><span>.</span><span style=color:#62a35c>entries</span><span>(gist)
</span><span>    </span><span style=font-weight:700;color:#a71d5d>for</span><span>(</span><span style=font-weight:700;color:#a71d5d>let </span><span>val </span><span style=font-weight:700;color:#a71d5d>of </span><span>arr) {
</span><span>      </span><span style=font-weight:700;color:#a71d5d>const </span><span style=color:#0086b3>art </span><span style=font-weight:700;color:#a71d5d>= </span><span>val[</span><span style=color:#0086b3>1</span><span>]
</span><span>      </span><span style=font-weight:700;color:#a71d5d>if </span><span>(art.gistid </span><span style=font-weight:700;color:#a71d5d>!== </span><span style=color:#0086b3>undefined</span><span>) {
</span><span>        art.url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>`https://gist.github.com/${</span><span>art</span><span style=color:#183691>.</span><span>owner</span><span style=color:#183691>}/${</span><span>art</span><span style=color:#183691>.</span><span>gistid</span><span style=color:#183691>}`
</span><span>        </span><span style=font-weight:700;color:#a71d5d>const </span><span style=color:#0086b3>j </span><span style=font-weight:700;color:#a71d5d>= await </span><span>axios.</span><span style=color:#62a35c>get</span><span>(</span><span style=color:#183691>`${</span><span>art</span><span style=color:#183691>.</span><span>url</span><span style=color:#183691>}.json`</span><span>)
</span><span>        </span><span style=font-weight:700;color:#a71d5d>if </span><span>(j.data </span><span style=font-weight:700;color:#a71d5d>=== </span><span style=color:#0086b3>undefined</span><span>)
</span><span>          art.content </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>`could not load ${</span><span>art</span><span style=color:#183691>.</span><span>url</span><span style=color:#183691>}.json`
</span><span>        </span><span style=font-weight:700;color:#a71d5d>else </span><span>{
</span><span>          art.content </span><span style=font-weight:700;color:#a71d5d>= </span><span>j.data.div
</span><span>          art.description </span><span style=font-weight:700;color:#a71d5d>= </span><span>j.data.description
</span><span>          art.created_at </span><span style=font-weight:700;color:#a71d5d>= </span><span>j.data.created_at.</span><span style=color:#62a35c>substring</span><span>(</span><span style=color:#0086b3>0</span><span>, </span><span style=color:#0086b3>10</span><span>)
</span><span>        }
</span><span>      }
</span><span>    }
</span><span>    </span><span style=font-weight:700;color:#795da3>commit</span><span>(</span><span style=color:#183691>'mutations'</span><span>, arr)
</span><span>  },
</span></code></pre><ul><li>取ってきたjsonの中のhtmlセグメント中の <code>iframe</code> の大きさの取り扱いにも一苦労。 jupyter notebookを貼り付けたgistだけは<code>height: auto</code>が効かない（コンテンツの高さがデフォルトの150pxに固定されてしまう）。しょうがないので、設定ファイル中でipynbかどうかを指定するフラグを用意して、そのフラグが立っていたら、<code>height: 2000px;</code>にしてしまうクラスを使うようにしました。（青い枠線が表示される場合があるのはデバッグ中の設定の名残りです。）</ul><pre class=language-js data-lang=js style=background:#fff;color:#323232><code class=language-js data-lang=js><span style=font-style:italic;color:#969896>// pages/_year/_slug/ghc/index.vue > template
</span><span>
</span><span>      </span><span style=font-weight:700;color:#a71d5d><</span><span>div :id</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>"$route.params.slug" </span><span>class</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>"githubgist-content"</span><span> :class</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>"{ 'githubgist-frame': article.frame }"</span><span style=font-weight:700;color:#a71d5d>>
</span><span>        </span><span style=font-weight:700;color:#a71d5d><</span><span>span v</span><span style=font-weight:700;color:#a71d5d>-</span><span>html</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>"article.content"</span><span style=font-weight:700;color:#a71d5d>></span><span>&LT/span>
</span><span>      </span><span style=font-weight:700;color:#a71d5d>&LT/</span><span>div</span><span style=font-weight:700;color:#a71d5d>>
</span><span>
</span></code></pre><ul><li>後は<code>axios.get</code> ではデータそのものではなくレスポンスが返ってくるので</ul><pre class=language-js data-lang=js style=background:#fff;color:#323232><code class=language-js data-lang=js><span style=font-weight:700;color:#a71d5d>const </span><span style=color:#0086b3>json </span><span style=font-weight:700;color:#a71d5d>= </span><span>axios.</span><span style=color:#62a35c>get</span><span>(url).</span><span style=color:#62a35c>then</span><span>((res) </span><span style=font-weight:700;color:#a71d5d>=> </span><span>{ </span><span style=font-weight:700;color:#a71d5d>return </span><span>res.data })
</span></code></pre><p>でなければいけない問題。これもちょっとはまりました。<p>一個一個の問題は大したことないのだけど、切り分けができない多数の問題が降ってきたので、あああ、疲れた。<p>さて、なんでgithubの返す埋め込み用javascriptをそのまま使うのをやめたんだっけ？ 最初に何も考えずにObservableのコードを流用したら動かなかったのは確かなんだけど。。。<div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2020-08-14</div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#jang>#jang</a></div><div class=navbar-item><a class=tagword href=/tags/#vuejs>#vuejs</a></div><div class=navbar-item><a class=tagword href=/tags/#nuxtjs>#nuxtjs</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>