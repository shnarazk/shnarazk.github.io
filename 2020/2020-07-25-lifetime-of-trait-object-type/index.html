<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>まとめて借用</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">in Rust</h1><p>オブジェクトからフィールドを借用したい。 借用したいオブジェクトの型がいくつもあり、型ごとに借用したい個数が違うので、できるだけgenericなtrait化が望ましい。 よくわかってないとこの程度のことでもつまづいてしまうのでメモしておく。<h3 id=Box>Box</h3><p>困った時は一旦スタックに持っていく、そのために <code>Box</code> を使う、という定石を使ってみるとこうなる。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>pub trait </span><span>Export<'a, T> {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>exports</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> </span><span style=color:#0086b3>Box</span><span>&LTT>;
</span><span>}
</span><span>
</span><span style=font-weight:700;color:#a71d5d>impl</span><span><</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> Export<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, (</span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2)> </span><span style=font-weight:700;color:#a71d5d>for </span><span>Restarter {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>exports</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> </span><span style=color:#0086b3>Box</span><span><(</span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2)> {
</span><span>        </span><span style=color:#0086b3>Box</span><span>::from((</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.asg.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.lbd.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.mld.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.mva.ema))
</span><span>    }
</span><span>}
</span></code></pre><p>問題なくコンパイルできる。使うときは一回derefする。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span>    </span><span style=font-weight:700;color:#a71d5d>let </span><span>(rst_asg, rst_lbd, </span><span style=font-weight:700;color:#a71d5d>_</span><span>, </span><span style=font-weight:700;color:#a71d5d>_</span><span>) </span><span style=font-weight:700;color:#a71d5d>= *</span><span>rst.</span><span style=color:#62a35c>exports</span><span>();
</span></code></pre><h3 id=タプル>タプル</h3><p>タプルに置き換えても問題ない。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>pub trait </span><span>Export<'a, T> {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>exports</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> T;
</span><span>}
</span><span>
</span><span style=font-weight:700;color:#a71d5d>impl</span><span><</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> Export<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, (</span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2)> </span><span style=font-weight:700;color:#a71d5d>for </span><span>Restarter {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>exports</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> (</span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2) {
</span><span>	    (</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.asg.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.lbd.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.mld.ema, </span><span style=font-weight:700;color:#a71d5d>&</span><span>self.mva.ema)
</span><span>    }
</span><span>}
</span></code></pre><h3 id=CoWs_in_tuple>CoWs in tuple</h3><p>さらに一般化して定数データもコピーなしで返すために<a href=https://doc.rust-lang.org/std/borrow/enum.Cow.html>CoW</a>でくるんでも全然問題ない。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>use </span><span>std::borrow::Cow;
</span><span>
</span><span style=font-weight:700;color:#a71d5d>trait </span><span>Export<'a> {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>export</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> (Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>, Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>);
</span><span>}
</span><span>
</span><span style=font-weight:700;color:#a71d5d>impl</span><span><</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> Export<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> </span><span style=font-weight:700;color:#a71d5d>for </span><span>Restarter {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>export</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> (Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>, Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>) {
</span><span>        (Cow::Owned(</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.asg.ema), Cow::Owned(</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.lbd.ema))
</span><span>    }
</span><span>}
</span></code></pre><p>ただし、これは2要素タプルに特定してしまっている。<p>一般化した問題に戻して、<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>trait </span><span>Export<'a, T> {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>export</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> T;
</span><span>}
</span></code></pre><p>とするなら、<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>impl</span><span><</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> Export<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, (Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2>, Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2>)> </span><span style=font-weight:700;color:#a71d5d>for </span><span>Restarter {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>export</span><span>(</span><span style=font-weight:700;color:#a71d5d>&'a </span><span>self) -> (Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2>, Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&'a</span><span> Ema2>) {
</span><span>        (Cow::Owned(</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.asg.ema), Cow::Owned(</span><span style=font-weight:700;color:#a71d5d>&</span><span>self.lbd.ema))
</span><span>    }
</span><span>}
</span></code></pre><p>とすればいい。どれも全く同じことだった。<h1 id=エンバグ>エンバグ</h1><p>なお、これを<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>impl</span><span><</span><span style=font-weight:700;color:#a71d5d>'a</span><span>> Export<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, (Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>, Cow<</span><span style=font-weight:700;color:#a71d5d>'a</span><span>, </span><span style=font-weight:700;color:#a71d5d>&</span><span>Ema2>)> </span><span style=font-weight:700;color:#a71d5d>for </span><span>Restarter
</span></code></pre><p>などとして、ライフタイム制約が不十分なものに（うっかり）してしまうと、<pre style=background:#fff;color:#323232><code><span>error[E0308]: method not compatible with trait
</span><span>   --> src/solver/restart.rs:833:5
</span><span>    |
</span><span>833 |     fn export(&'a self) -> (Cow<'a, &'a Ema2>, Cow<'a, &'a Ema2>) {
</span><span>    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ lifetime mismatch
</span><span>    |
</span><span>    = note: expected fn pointer `fn(&'a solver::restart::Restarter) -> (std::borrow::Cow<'_, &types::Ema2>, std::borrow::Cow<'_, _>)`
</span><span>               found fn pointer `fn(&'a solver::restart::Restarter) -> (std::borrow::Cow<'_, &'a types::Ema2>, std::borrow::Cow<'_, _>)`
</span></code></pre><p>だとか、<pre style=background:#fff;color:#323232><code><span>error[E0308]: method not compatible with trait
</span><span>   --> src/solver/restart.rs:833:5
</span><span>    |
</span><span>833 |     fn export(&'a self) -> (Cow<'a, &Ema2>, Cow<'a, &Ema2>) {
</span><span>    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ lifetime mismatch
</span><span>    |
</span><span>    = note: expected fn pointer `fn(&'a solver::restart::Restarter) -> (std::borrow::Cow<'_, &types::Ema2>, std::borrow::Cow<'_, &types::Ema2>)`
</span><span>               found fn pointer `fn(&'a solver::restart::Restarter) -> (std::borrow::Cow<'_, &'a types::Ema2>, std::borrow::Cow<'_, &'a types::Ema2>)`
</span><span>note: the lifetime `'_` as defined on the impl at 832:33...
</span></code></pre><p>と言われてしまうが、まあそりゃ当たり前のことである。<p>以下は単なる文法間違いがもたらしたエラー。<pre style=background:#fff;color:#323232><code><span>error: lifetime in trait object type must be followed by `+`
</span><span>  --> src/types.rs:32:38
</span><span>   |
</span><span>32 |     fn exports(&'a self) -> (CoW('a, Ema), CoW('a, Ema));
</span><span>   |                                  ^^
</span></code></pre><p>ちゃんとライフタイム制約まで目を配りましょうというだけのことでした。<div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2020-07-25   Last updated 2020-08-05 </div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#rust>#Rust</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>