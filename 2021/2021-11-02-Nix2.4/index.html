<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>Nix 2.4 released</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-banner><img src=/2021/2021-11-02_banner-2.jpg></div><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">experimental-features = nix-command flakes</h1><h1 id=2021-11-11:_flake.nixの更新>2021-11-11: flake.nixの更新</h1><p>git repositoryに含まれないflake.nixは<pre style=background:#fff;color:#323232><code><span>nix build ./#
</span></code></pre><p>でbuildを試せる。 errorが出るのをわかっていてわざわざcommitして結果を試してみる必要はないのでflakesに大量のコミットログを残さなくて済むはずだ。<p>ただ、おかしなことにこの状態だとsha256の不一致エラーが出ない。 その確認がこのステップの目的なんだけど。<h4 id=sha256の出し方>sha256の出し方</h4><p>ということで調べた。例えば、<pre style=background:#fff;color:#323232><code><span># flakes/kissat/flake.nix
</span><span>          src = fetchFromGitHub {
</span><span>            owner = "arminbiere";
</span><span>            repo = "kissat";
</span><span>            rev = "abfa45fb782fa3b7c6e2eb6b939febe74d7270b7";
</span><span>            sha256 = "06pbmkjxgf2idhsrd1yzvbxr2wf8l06pjb38bzbygm6n9ami89b8";
</span><span>          };
</span></code></pre><p>からダウンロードされるものは、<pre style=background:#fff;color:#323232><code><span>https:/github.com/${owenr}/${repo}/archive/${rev}.tar.gz
</span></code></pre><p>これを<code>nix-prefetch-url</code>に渡す。<pre style=background:#fff;color:#323232><code><span>$ nix-prefetch-url --type sha256 --unpack https:/github.com/arminbiere/kissat/archive/abfa45fb782fa3b7c6e2eb6b939febe74d7270b7.tar.gz
</span><span>path is '/nix/store/2nb50j4lv4ab9waps7awqbwg1x1fvljn-abfa45fb782fa3b7c6e2eb6b939febe74d7270b7.tar.gz'
</span><span>06pbmkjxgf2idhsrd1yzvbxr2wf8l06pjb38bzbygm6n9ami89b8
</span><span>$ 
</span></code></pre><p>これが<code>sha256</code>になる。<h1 id=2021-11-09:_nix_profile_install_nixpkgs/nixpkgs-unstable#nix_2_4_できない件>2021-11-09: <code>nix profile install nixpkgs/nixpkgs-unstable#nix_2_4</code> できない件</h1><p>いや、別にuser profileから消えてもSSDから消えるわけではないので、ビクビクせずに、<pre style=background:#fff;color:#323232><code><span>/nix/var/nix/profiles/per-user/nash/profile-XX-link/bin/nix profile remove nix
</span><span>/nix/var/nix/profiles/per-user/nash/profile-XX-link/bin/nix profile install nixpkgs/nixpkgs-unstable#nix_2_4
</span></code></pre><p>すればいいだけだった。<p>これで残ったのはcacertだけ。 これを消すと新しいパッケージの認証に失敗して何もインストールできなくなるのではと思っていたのが、やってみたたらできた。 ただし、一回conflict起こさせておくことが必要。つまりダウンロードしてlocal storeに展開までしておけば認証が終わっているということなので、それ以降cacertは要らない。<p>さようなら、channels。ようこそ、experimental nix-command and flakes。<h1 id=githubにリポジトリを作って自分の環境を構築する(2021-11-06-2)>githubにリポジトリを作って自分の環境を構築する(2021-11-06-2)</h1><p>これでどうだ。upgradeで更新しなくなったぞ。<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span style=font-style:italic;color:#969896>#github:shnarazk/flakes/flake.nix
</span><span>{
</span><span>  </span><span style=color:#795da3>description </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"Piling up my flakes"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>    </span><span style=color:#795da3>flake-utils</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:numtide/flake-utils</span><span>;
</span><span>    </span><span style=color:#795da3>emacs-head</span><span>.</span><span style=color:#795da3>url  </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:shnarazk/flakes?dir=emacs-head</span><span>;
</span><span>    </span><span style=color:#795da3>kissat</span><span>.</span><span style=color:#795da3>url      </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:shnarazk/flakes?dir=kissat</span><span>;
</span><span>  };
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>flake-utils</span><span style=font-weight:700;color:#a71d5d>, </span><span>emacs-head</span><span style=font-weight:700;color:#a71d5d>, </span><span>kissat }:
</span><span>    flake-utils</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>eachDefaultSystem (system:
</span><span>      {
</span><span>        </span><span style=color:#795da3>packages </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>          </span><span style=color:#795da3>emacs-head </span><span style=font-weight:700;color:#a71d5d>= </span><span>emacs-head</span><span style=font-weight:700;color:#a71d5d>.</span><span>defaultPackage</span><span style=font-weight:700;color:#a71d5d>.</span><span>${system};
</span><span>          </span><span style=color:#795da3>kissat </span><span style=font-weight:700;color:#a71d5d>= </span><span>kissat</span><span style=font-weight:700;color:#a71d5d>.</span><span>defaultPackage</span><span style=font-weight:700;color:#a71d5d>.</span><span>${system};
</span><span>        };
</span><span>      }
</span><span>    );
</span><span>}
</span></code></pre><h1 id=ちゃんと理解して複数のflake.nixをまとめ上げて自分の環境を構築する(2021-11-06)>ちゃんと理解して複数のflake.nixをまとめ上げて自分の環境を構築する(2021-11-06)</h1><p><a href=https://blog.ysndr.de/posts/internals/2021-01-01-flake-ification/>これ</a>見て（さらに2時間奮闘して）理解した。<p><del>こういうことだ。なるほど、これはほぼflakesの合成をやっているだけだ。</del> さらに1時間bug fixに苦戦して結局<a href=https://github.com/shnarazk/flakes/blob/main/flake.nix>こういうこと</a>になった。<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span style=font-style:italic;color:#969896># flake.nix
</span><span>{
</span><span>  </span><span style=color:#795da3>description </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"Piling up my flakes"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>nixpkgs</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:NixOS/nixpkgs/nixpkgs-unstable</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>flake-utils</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:numtide/flake-utils</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>emacs-head</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"./emacs-head"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>kissat</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"./kissat"</span><span>;
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs</span><span style=font-weight:700;color:#a71d5d>, </span><span>flake-utils</span><span style=font-weight:700;color:#a71d5d>, </span><span>emacs-head</span><span style=font-weight:700;color:#a71d5d>, </span><span>kissat }:
</span><span>    flake-utils</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>eachDefaultSystem (system:
</span><span>      {
</span><span>        </span><span style=color:#795da3>packages </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>          </span><span style=color:#795da3>emacs-head </span><span style=font-weight:700;color:#a71d5d>= </span><span>emacs-head</span><span style=font-weight:700;color:#a71d5d>.</span><span>defaultPackage</span><span style=font-weight:700;color:#a71d5d>.</span><span>${system};
</span><span>          </span><span style=color:#795da3>kissat </span><span style=font-weight:700;color:#a71d5d>= </span><span>kissat</span><span style=font-weight:700;color:#a71d5d>.</span><span>defaultPackage</span><span style=font-weight:700;color:#a71d5d>.</span><span>${system};
</span><span>        };
</span><span>      }
</span><span>    );
</span><span>}
</span></code></pre><p>「それはderivationじゃないエラー」を修正し、全systemに対応していったら、1時間前のバージョンととも全然違うものになってしまった。うーむ正解なのか？ flakesの階層合成はどこかに説明されてないのか。<pre style=background:#fff;color:#323232><code><span>{ a: {x: ka, y: la, z: ma}, b: {x: kb, y: lb, z: mb}, c: {x: kc, y: lc, z: mc} }
</span><span>=>
</span><span>{ x: {a: ka, b: kb, c: kc}, y: {a: la, b: lb, c: lc}, z: {a: ma, b: mb, c: mc} }
</span></code></pre><p><a href=https://github.com/numtide/flake-utils>flake-utils</a>にはない、Optics的な何か。<p>いや、まだダメだわ。二つのフレークが共有してはいけないものまで共有していて、flake.lockのupdateが止まらない。 <code>nix profile upgrade</code>でも毎回inputが更新されてしまう。<h1 id=非常に浅い理解でflake.nixを作って自分のパッケージをインストールする(2021-11-05)>非常に浅い理解でflake.nixを作って自分のパッケージをインストールする(2021-11-05)</h1><pre style=background:#fff;color:#323232><code><span>nix build
</span><span>nix profile install result/
</span></code></pre><p>一方、channelに対するoverlayはなくなった（はず）なので、さて勝手に最新バージョンをbuildするにはどうしたものか。<p>例えば、emacs27に対するoverlayだったemacs-headは以下のようにしてemacs28というattributeを注入していた。<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span style=font-style:italic;color:#969896># emacs-head.nix
</span><span>self: super: {
</span><span>  </span><span style=color:#795da3>emacs28 </span><span style=font-weight:700;color:#a71d5d>= </span><span>super</span><span style=font-weight:700;color:#a71d5d>.</span><span>emacs</span><span style=font-weight:700;color:#a71d5d>.</span><span>overrideAttrs (attrs: </span><span style=font-weight:700;color:#a71d5d>rec </span><span>{
</span><span>    </span><span style=color:#795da3>pname </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"emacs-head"</span><span>;
</span><span>    </span><span style=color:#795da3>name </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"emacs-head-${</span><span>version</span><span style=color:#183691>}"</span><span>;
</span><span>    </span><span style=color:#795da3>version </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"28.0.60"</span><span>;
</span></code></pre><p>flakeにするとderivationを一つ返すファイルflake.nixが必要になる。 <em>ここが浅い理解。それではnixpkgs/flake.nixが理解できないではないか。</em> なのでemacs28が追加された集合を作るのでははなく、できたderivationをそのまま返せばいい(<code>defaultPackage.${system}</code>に代入している)。<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span style=font-style:italic;color:#969896># flake.nix
</span><span>{
</span><span>  </span><span style=color:#795da3>description </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"Emacs Head, the unreleased 28.0"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>nixpkgs</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:NixOS/nixpkgs/nixpkgs-unstable</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>flake-utils</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:numtide/flake-utils</span><span>;
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs</span><span style=font-weight:700;color:#a71d5d>, </span><span>flake-utils }:
</span><span>    flake-utils</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>eachDefaultSystem (system: {
</span><span>      </span><span style=color:#795da3>defaultPackage </span><span style=font-weight:700;color:#a71d5d>=
</span><span>        </span><span style=font-weight:700;color:#a71d5d>with </span><span style=color:#62a35c>import </span><span>nixpkgs { </span><span style=color:#795da3>system </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"x86_64-darwin"</span><span>; };
</span><span>        emacs27</span><span style=font-weight:700;color:#a71d5d>.</span><span>overrideAttrs (attrs: </span><span style=font-weight:700;color:#a71d5d>rec </span><span>{
</span><span>          </span><span style=color:#795da3>name </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"emacs-head-${</span><span>version</span><span style=color:#183691>}"</span><span>;
</span><span>          </span><span style=color:#795da3>pname </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"emacs-head"</span><span>;
</span><span>          </span><span style=color:#795da3>version </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"28.0.60"</span><span>;
</span></code></pre><ul><li>ファイル名がflake.nix固定なので、インストールしたいパッケージごとにディレクトリを作らないといけない。 flakesリポジトリのサブディレクトリとしてまとめたいのだが。なんかうまくいかない。<li><code>nix profile install</code>でのインストールがうまくいかない。そのためにはできたderivationを<code>nixpkgs.defaultPackeges</code> または<code>legacyPackages</code>に注入しないといけないのだが、見ればわかるようにやってない。それはflake.nixではなくdefault.nixだかshell.nixの仕事のような気がする。<code>nix build & nix install result/</code>はうまくいく。</ul><hr><p><img alt src=/2021/2021-11-02_banner.jpg><h1 id=2021-11-06>2021-11-06</h1><ul><li><a href=https://discourse.nixos.org/t/nix-2-4-released/15822/5>Announcement on Nix discourse</a><li><a href=https://nixos.org/manual/nix/stable/>Manual (for version 2.4)</a></ul><p>だんだんわかってきたので箇条書きに変更した。<h3 id=パッケージの更新>パッケージの更新</h3><pre style=background:#fff;color:#323232><code><span>nix profile upgrade '.*'
</span></code></pre><p>flakeはTTLが切れたら勝手に更新してくれる。<p>ただし、こうしたいならchannelからではなくflakeからパッケージをインストールしなければならない。 以下はnixpkgs-unstable channelからnixpkgs/nixpkgs-unstable registryへ引越しの途中の状態。<pre style=background:#fff;color:#323232><code><span>0 - - /nix/store/l1nnjj26j4nfggzfdp25d5074m35xrwa-parallel-20210722
</span><span>4 - - /nix/store/6kaig6yyxm6mfha5b21x827dkfazb0cg-ispell-3.4.04
</span><span>7 - - /nix/store/ghshklfk3q98cikad1wf8b0rpwhmp1iz-tmux-3.2a
</span><span>8 - - /nix/store/475pa4h5rd6289zm8iga507ppl3k9zwn-nix-2.4pre-rc1
</span><span>5 - - /nix/store/wiqcjg66s7sb6cais8pifrk3l9cpkrmq-nss-cacert-3.66
</span><span>7 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.tmux github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.tmux /nix/store/ghshklfk3q98cikad1wf8b0rpwhmp1iz-tmux-3.2a
</span><span>11 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.ispell github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.ispell /nix/store/6kaig6yyxm6mfha5b21x827dkfazb0cg-ispell-3.4.04
</span><span>14 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.parallel github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.parallel /nix/store/l1nnjj26j4nfggzfdp25d5074m35xrwa-parallel-20210722
</span></code></pre><p>この状態からどうやってnixを移行すればいいのだろう。 <code>nix</code>と<code>nix_2_4</code>とが同じ優先度を持っているのでそれを設定して上書き可能な状態にしなければいけないことはわかった。 しかし既にnix-envが使えない状況でどのコマンドを使えばそれができるのだろう。<p><a href=https://github.com/NixOS/nix/issues/5473>issue</a>立っているのでどうもできないようだ。ワハハ。<h3 id=パッケージの削除>パッケージの削除</h3><p><code>nix profile list</code>で通し番号を調べて<code>nix profile remove</code>で指定。<h3 id=ゴミの回収>ゴミの回収</h3><pre style=background:#fff;color:#323232><code><span>nix profile wipe-history --older-than 7d
</span></code></pre><h3 id=パッケージの検索>パッケージの検索</h3><pre class=language-sh data-lang=sh style=background:#fff;color:#323232><code class=language-sh data-lang=sh><span>nix search nixpkgs package-name
</span><span>nix search nixpkgs/nixpkgs-unstable package-name   </span><span style=font-style:italic;color:#969896># only a specified branch
</span></code></pre><p>flakeはキャッシュされるので<code>nix-env -qa</code>とは比べ物にならない。<p>なんか成熟感と新鮮さが同時にやってきた。<div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2021-11-02   Last updated 2021-11-11 </div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#nixos>#NixOS</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>