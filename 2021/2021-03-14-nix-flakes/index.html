<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>Nix flakeの作り方</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-banner><img src="https://images.unsplash.com/photo-1482597869166-609e91429f40?ixlib=rb-1.2.1&ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&auto=format&fit=crop&w=2400"></div><div class=article-banner-caption>https://unsplash.com/photos/U2L0qbBw9Jo</div><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">さあ来いnix-2.4</h1><p>2021-03-08にnix-2.4のpre-release版が三ヶ月ぶりに更新されて、ようやくnixを置き換えてもエラーなく使えるようになりました。（いやそうでもないみたいだぞ。。。@2021-03-16） なので早速Splrで使ってみたのでいくつかメモ。<h2 id=restricted_modeとは>restricted modeとは</h2><p><code>nix-env -u</code>でエラーはなくなったものの、flake.nixを作ろうとすると相変わらずrestricted modeではxxxxにアクセスできないというようなエラーが出る。これは<code>--impure</code>フラグを渡してやるといい。<code>nix --help</code>によると、<blockquote><p>When the --expr option is given, all installables are interpreted as Nix expressions. You may need to specify --impure if the expression references impure inputs (such as <code>&LTnixpkgs></code>).</blockquote><p>ということで、多分12月頃からこうすればよかったようだ。<pre class=language-txt data-lang=txt style=background:#fff;color:#323232><code class=language-txt data-lang=txt><span>$ nix flake init --impure
</span><span>$ nix build --impure
</span></code></pre><h2 id=flake.nixはどう書けばいいのか>flake.nixはどう書けばいいのか</h2><p><a href=https://nixos.wiki/wiki/Flakes>Nix Wiki</a>に出てくるのは以下の例<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#795da3>inputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{
</span><span>    </span><span style=color:#795da3>home-manager</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"github:nix-community/home-manager"</span><span>;
</span><span>  };
</span><span>}
</span></code></pre><pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs }: {
</span><span>     </span><span style=font-style:italic;color:#969896># replace 'joes-desktop' with your hostname here.
</span><span>     </span><span style=color:#795da3>nixosConfigurations</span><span>.</span><span style=color:#795da3>joes-desktop </span><span style=font-weight:700;color:#a71d5d>= </span><span>nixpkgs</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>nixosSystem {
</span><span>       </span><span style=color:#795da3>system </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"x86_64-linux"</span><span>;
</span><span>       </span><span style=color:#795da3>modules </span><span style=font-weight:700;color:#a71d5d>= </span><span>[ </span><span style=color:#183691>./configuration.nix </span><span>];
</span><span>     };
</span><span>  };
</span><span>}
</span></code></pre><p>しかし、2020年5月の記事だけど<a href=https://www.tweag.io/blog/2020-05-25-flakes/>NIX FLAKES, PART 1: AN INTRODUCTION AND TUTORIAL</a>の以下の例がまず足掛かり。<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#795da3>description </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"A flake for building Hello World"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>nixpkgs</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>github:NixOS/nixpkgs/nixos-20.03</span><span>;
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs }: {
</span><span>    </span><span style=color:#795da3>defaultPackage</span><span>.</span><span style=color:#795da3>x86_64-linux </span><span style=font-weight:700;color:#a71d5d>=
</span><span>      </span><span style=font-style:italic;color:#969896># Notice the reference to nixpkgs here.
</span><span>      </span><span style=font-weight:700;color:#a71d5d>with </span><span style=color:#62a35c>import </span><span>nixpkgs { </span><span style=color:#795da3>system </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"x86_64-linux"</span><span>; };
</span><span>      stdenv</span><span style=font-weight:700;color:#a71d5d>.</span><span>mkDerivation {
</span><span>        </span><span style=color:#795da3>name </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"hello"</span><span>;
</span><span>        </span><span style=color:#795da3>src </span><span style=font-weight:700;color:#a71d5d>= </span><span>self;
</span><span>        </span><span style=color:#795da3>buildPhase </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"gcc -o hello ./hello.c"</span><span>;
</span><span>        </span><span style=color:#795da3>installPhase </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"mkdir -p $out/bin; install -t $out/bin hello"</span><span>;
</span><span>      };
</span><span>  };
</span><span>}
</span></code></pre><p>これを真似すればよさそうだが、この例ではsystemが <code>x86_64-linux</code> に限定されている。 いや <code>darwin</code> メインだし将来的には <code>aarch65</code> も期待したいのでもっとスマートな方法はないかと探すと、 Nix Wikiで使われている<a href=https://github.com/numtide/flake-utils>flake-utils</a>がよさそうである。このパッケージは<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>eachDefaultSystem </span><span style=font-weight:700;color:#a71d5d>-> </span><span>(</span><span style=color:#183691>&LTsystem> </span><span style=font-weight:700;color:#a71d5d>-> </span><span>attrs)
</span></code></pre><p>を提供している。ええと、これは返値がないように見えるけどこういうこと：<pre class=language-haskell data-lang=haskell style=background:#fff;color:#323232><code class=language-haskell data-lang=haskell><span style=font-weight:700;color:#795da3>eachDefaultSystem </span><span style=font-weight:700;color:#a71d5d>::</span><span> (&LTsystem> </span><span style=font-weight:700;color:#a71d5d>-> </span><span>attrs) </span><span style=font-weight:700;color:#a71d5d>-> </span><span>attrs
</span></code></pre><p>ただし、使い方は微妙である。 よくわからないまま使うと、例えば<code>defaultPackege.x86-64-darwin</code>がエクスポートされていないというエラーが出てしまった。 でこれによく似た関数<code>eachSystem</code>の<a href=https://github.com/numtide/flake-utils#user-content-eachsystem---system---system---attrs>サンプル</a>をよく見る：<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>eachSystem allSystems (system: { </span><span style=color:#795da3>hello </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#0086b3>42</span><span>; })
</span><span style=font-style:italic;color:#969896># => {
</span><span>   hello</span><span style=font-weight:700;color:#a71d5d>.</span><span>aarch64-darwin </span><span style=background:#f5f5f5;font-weight:700;color:#b52a1d>=</span><span> </span><span style=color:#0086b3>42</span><span style=background:#f5f5f5;font-weight:700;color:#b52a1d>,</span><span>
</span><span>   hello</span><span style=font-weight:700;color:#a71d5d>.</span><span>aarch64-genode </span><span style=background:#f5f5f5;font-weight:700;color:#b52a1d>=</span><span> </span><span style=color:#0086b3>42</span><span style=background:#f5f5f5;font-weight:700;color:#b52a1d>,</span><span>
</span><span style=background:#f5f5f5;font-weight:700;color:#b52a1d>}</span><span>
</span></code></pre><p>引数closureの中で<code>hello</code>を使うと最終的に<code>hello.${system}</code>にpopulateされるのだから、<code>defaultPackege.色々なシステム</code>をpopulateするにはclosureの中では<code>defaultPackage</code>にderivationを束縛すればいい。 ということで<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>flake-utils</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"github:numtide/flake-utils"</span><span>;
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs</span><span style=font-weight:700;color:#a71d5d>, </span><span>flake-utils }:
</span><span>    flake-utils</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>eachDefaultSystem (system: {
</span><span>      </span><span style=color:#795da3>defaultPackage </span><span style=font-weight:700;color:#a71d5d>=
</span><span>        </span><span style=font-weight:700;color:#a71d5d>with </span><span style=color:#62a35c>import </span><span>nixpkgs { </span><span style=color:#795da3>system </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"${</span><span>system</span><span style=color:#183691>}"</span><span>; };
</span><span>        stdenv</span><span style=font-weight:700;color:#a71d5d>.</span><span>mkDerivation {...};
</span><span>    });
</span><span>}
</span></code></pre><p>とするのが正解。 <a href=https://github.com/shnarazk/splr/blob/f34a664f0f031a9ffe0c4c63558f33ab6b90eec1/flake.nix>実際のコード</a>はこれ:<pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#795da3>description </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"A modern SAT solver in Rust"</span><span>;
</span><span>  </span><span style=color:#795da3>inputs</span><span>.</span><span style=color:#795da3>flake-utils</span><span>.</span><span style=color:#795da3>url </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"github:numtide/flake-utils"</span><span>;
</span><span>  </span><span style=color:#795da3>outputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>{ self</span><span style=font-weight:700;color:#a71d5d>, </span><span>nixpkgs</span><span style=font-weight:700;color:#a71d5d>, </span><span>flake-utils }:
</span><span>    flake-utils</span><span style=font-weight:700;color:#a71d5d>.</span><span>lib</span><span style=font-weight:700;color:#a71d5d>.</span><span>eachDefaultSystem (system: {
</span><span>      </span><span style=color:#795da3>defaultPackage </span><span style=font-weight:700;color:#a71d5d>=
</span><span>        </span><span style=font-weight:700;color:#a71d5d>with </span><span style=color:#62a35c>import </span><span>nixpkgs { </span><span style=color:#795da3>system </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"${</span><span>system</span><span style=color:#183691>}"</span><span>; };
</span><span>        stdenv</span><span style=font-weight:700;color:#a71d5d>.</span><span>mkDerivation {
</span><span>          </span><span style=color:#795da3>name </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"splr"</span><span>;
</span><span>          </span><span style=color:#795da3>src </span><span style=font-weight:700;color:#a71d5d>= </span><span>self;
</span><span>          </span><span style=color:#795da3>buildInputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>[ cargo rustc ];
</span><span>          </span><span style=color:#795da3>buildPhase </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"cargo build --release"</span><span>;
</span><span>          </span><span style=color:#795da3>installPhase </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#183691>"mkdir -p $out/bin; install -t $out/bin target/release/splr target/release/dmcr"</span><span>;
</span><span>        }
</span><span>      ;
</span><span>    })
</span><span>  ;
</span><span>}
</span></code></pre><p>これでgit cloneしてnix buildでインストールできるようになりました。 うむ。簡単。 オーバレイでnixパッケージ化するよりもお手軽なので、<a href=https://github.com/shnarazk/SAT-bench>SAT-bench</a>も乗り換えるかも。<p>初めてFlakesを知ってから半年というか約1年。 長い道のりでした。<h3 id=MacOSでRustのプログラムがコンパイルできない>MacOSでRustのプログラムがコンパイルできない</h3><p><code>framework Security</code>がないとか言われるなら、それはnixパッケージ化した時と同じような環境を作ってやらなければ。 ということでwebまわりの機能を使うSAT-benchの場合は以下の修正が必要だった。<pre style=background:#fff;color:#323232><code><span>1 file changed, 1 insertion(+), 1 deletion(-)
</span><span>flake.nix | 2 +-
</span><span>
</span><span>modified   flake.nix
</span><span>@@ -8,7 +8,7 @@
</span><span>         stdenv.mkDerivation {
</span><span>           name = "SAT-bench";
</span><span>           src = self;
</span><span>-          buildInputs = [ cargo rustc ];
</span><span>+          buildInputs = rustc.buildInputs ++ [ cargo rustc libiconv openssl pkgconfig ];
</span><span>           buildPhase = "cargo build --release";
</span><span>           installPhase = "mkdir -p $out/bin; install -t $out/bin target/release/sat-bench target/release/benchm";
</span><span>         }
</span></code></pre><div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2021-03-14   Last updated 2021-03-16 </div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#nixos>#NixOS</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>