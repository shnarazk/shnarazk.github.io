<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>Benchmarking Squeak, Pharo and Cuis</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">Let's pi</h1><h3 id=2022-04-09>2022-04-09</h3><ul><li>最近のVMでCuisを測り直してみたけど、まあ大きな変化はありませんでした。<li>Rayonを使った並列版Rustを追加しました。</ul><h1 id=They_depend_on_opensmalltalk-vm,_of_course.>They depend on opensmalltalk-vm, of course.</h1><p>全くつまらないPHPでのプログラミングなどというようなものをやらされているので、そんなもん使うくらいならSmalltalkの方がマシ。 とイライラが募り続けたせいで数年ぶりにSmalltalkをインストールしてチュートリアルをやりたい病にかかりました。<p>今回は<a href=http://www.cuis-smalltalk.org>Cuis Smalltalk</a>を試してみたのが新しいところ。 と思っていたらちょうど<a href=https://pharo.org/news/pharo10-released>Pharo 10</a>が出たのでそっちも試してみた。 さらにオープンソースがforkすると大抵本家はダメになっていくものだけど(X-Window Systems, Owncloud, LibreOffice, ...)、では現状一体どうなっているのか日本語の情報が全く途絶えてしまった<a href=https://squeak.org>Squeak</a>もついでにインストールして久しぶりにいじってみました。<p>結論から言うと個人的にはやっぱり型リッチな静的型付け関数型プログラミング全面支援言語をemacsかhelixでnixpkgsの基で作って使うのが一番だなあという結論なのだが、でもそれなりにSmalltalkは面白い。 実際のところどれ使ってもそれなりに面白いと言って過言ではない。 そしてダメダメな印象だったSqueakも十分に綺麗なデスクトップ環境で楽しく使えるのが今回の発見。 PHPよりはるかに楽しい。PHPよりはるかに楽しい。PHPよりはるかに楽しい。PHPよりはるかに楽しい。 金のためにXXXXXXXXX以下省略。<p>3大オープンソースSmalltalk語族をインストールしているというなかなかない状況なので、ベンチマークしてみた。題材は<a href=https://youtu.be/skh9suWVoD8>円周率の計算</a>というnumber crunchingもの。 プラットフォームはMacOS 12.3.1, x86-64.<table><thead><tr><th>language / implementation<th style=text-align:right>N<th style=text-align:left>value<th style=text-align:right>tallies<th style=text-align:right>time(msec.)<tbody><tr><td>Squeak 6.0alpha-21557-64bit.image<td style=text-align:right>100000<td style=text-align:left>3.141602653489794<td style=text-align:right>31,129<td style=text-align:right>31,511<tr><td><td style=text-align:right>200000<td style=text-align:left>3.1415976535647934<td style=text-align:right>126,296<td style=text-align:right>127,893<tr><td>Pharo10<td style=text-align:right>100000<td style=text-align:left>3.141602653489794<td style=text-align:right>32,107<td style=text-align:right>32,107<tr><td><td style=text-align:right>200000<td style=text-align:left>3.1415976535647934<td style=text-align:right>129,213<td style=text-align:right>129,213<tr><td>Cuis6.0-5105 + vm 6cd4bb2<td style=text-align:right>100000<td style=text-align:left>3.141602653489794<td style=text-align:right>19,289<td style=text-align:right>36,136<tr><td><td style=text-align:right>200000<td style=text-align:left>3.1415976535647934<td style=text-align:right>76,744<td style=text-align:right>145,776<tr><td>Cuis6.0-5069.image<td style=text-align:right>100000<td style=text-align:left>3.141602653489794<td style=text-align:right>17,571<td style=text-align:right>37,985<tr><td><td style=text-align:right>200000<td style=text-align:left>3.1415976535647934<td style=text-align:right>77,079<td style=text-align:right>150,123<tr><td><td style=text-align:right><td style=text-align:left><td style=text-align:right><td style=text-align:right><tr><td>Rust with <a href=https://crates.io/crates/rug>rug-1.15.0</a> on <a href=https://gmplib.org/>GMP</a><td style=text-align:right>100000<td style=text-align:left>3.1416026534897936<td style=text-align:right>--<td style=text-align:right>2.38 x 10^3<tr><td><td style=text-align:right>200000<td style=text-align:left>3.141597653564793<td style=text-align:right>--<td style=text-align:right>9.78 x 10^3<tr><td>Rust with rug and Rayon<td style=text-align:right>100000<td style=text-align:left>3.1416026534897936<td style=text-align:right>--<td style=text-align:right>0.18 x 10^3<tr><td><td style=text-align:right>200000<td style=text-align:left>3.141597653564793<td style=text-align:right>--<td style=text-align:right>0.61 x 10^3</table><p>まあcriterion使ったわけではなく、JITなシステムで一回のみの実行結果をまとめたものだから、細かい数値差には意味がないのは気に留めておく必要があるので、まずは大差なしというべきだろう。 Pharoなんか速くなってそうな印象があるのだけど結局同じ（ような）VMに依存しているので大きなアドバンテージがあるわけではないようだ。<p>そして、逆にSqueakが意外にいいじゃん(別に時代遅れなのはお前ら全部だw)という印象をここでも受けることになってしまった。<p>なのでここまではどれを使っても同じようなものという結論。 ただしSqueakのauto completion frameworkが一番肌に合わなかった、ドキュメントが全然更新されてなくてチュートリアル本すらないので敷居がどんどん高くなっているということは付け加えておきます。<p>さらに言うとPharoも公式サイトでリンクされたドキュメントが全然更新されない、または存在しないのでストレス溜まる。 Spec2とかFluidとかだから何なのか？ なんかRustと文化が違う。<h3 id=ついでにRustも--_2022-04-08>ついでにRustも-- 2022-04-08</h3><p>GMPをwrapしたライブラリで有理数を実装したRust版だとまあ10倍速い。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>use </span><span>rug::Rational;
</span><span>
</span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>main</span><span>() {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let</span><span> limit </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#0086b3>200_000</span><span>;
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let mut</span><span> curr_sum: Rational </span><span style=font-weight:700;color:#a71d5d>= </span><span>Rational::from((</span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>, </span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>));
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let mut</span><span> denominator: </span><span style=font-weight:700;color:#a71d5d>i64 = </span><span style=color:#0086b3>3</span><span>;
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let mut</span><span> adding </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#0086b3>false</span><span>;
</span><span>    </span><span style=font-weight:700;color:#a71d5d>for _ in </span><span style=color:#0086b3>0</span><span style=font-weight:700;color:#a71d5d>..</span><span>limit {
</span><span>        </span><span style=font-weight:700;color:#a71d5d>if</span><span> adding {
</span><span>            curr_sum </span><span style=font-weight:700;color:#a71d5d>+= </span><span>Rational::from((</span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>, denominator));
</span><span>        } </span><span style=font-weight:700;color:#a71d5d>else </span><span>{
</span><span>            curr_sum </span><span style=font-weight:700;color:#a71d5d>-= </span><span>Rational::from((</span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>, denominator));
</span><span>        }
</span><span>        denominator </span><span style=font-weight:700;color:#a71d5d>+= </span><span style=color:#0086b3>2</span><span>;
</span><span>        adding </span><span style=font-weight:700;color:#a71d5d>= !</span><span>adding;
</span><span>    }
</span><span>    println!(</span><span style=color:#183691>"limit:</span><span style=color:#0086b3>{}</span><span style=color:#183691> => </span><span style=color:#0086b3>{}</span><span style=color:#183691>"</span><span>, limit, </span><span style=color:#0086b3>4.0 </span><span style=font-weight:700;color:#a71d5d>*</span><span> curr_sum.</span><span style=color:#62a35c>to_f64</span><span>());
</span><span>}
</span></code></pre><h3 id=そして並列化--_2022-04-09>そして並列化-- 2022-04-09</h3><p>そして、Rayonで自動並列化をさせると（8 core CPU）、「一瞬」で終わってしまう。 Smalltalkはmulti coreやGPUといった現在のハードウェア資源をどう有効利用するのかという点でブレークスルーが必要だなあ。<pre class=language-rust data-lang=rust style=background:#fff;color:#323232><code class=language-rust data-lang=rust><span style=font-weight:700;color:#a71d5d>use </span><span>{rayon::prelude::</span><span style=font-weight:700;color:#a71d5d>*</span><span>, rug::Rational};
</span><span>
</span><span style=font-weight:700;color:#a71d5d>fn </span><span style=font-weight:700;color:#795da3>main</span><span>() {
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let</span><span> limit </span><span style=font-weight:700;color:#a71d5d>= </span><span style=color:#0086b3>200_000</span><span>;
</span><span>    </span><span style=font-weight:700;color:#a71d5d>let</span><span> result </span><span style=font-weight:700;color:#a71d5d>= </span><span>(</span><span style=color:#0086b3>0</span><span style=font-weight:700;color:#a71d5d>i64..=</span><span>limit)
</span><span>        .</span><span style=color:#62a35c>into_par_iter</span><span>()
</span><span>        .</span><span style=color:#62a35c>map</span><span>(|i| </span><span style=font-weight:700;color:#a71d5d>if</span><span> i </span><span style=font-weight:700;color:#a71d5d>% </span><span style=color:#0086b3>2 </span><span style=font-weight:700;color:#a71d5d>== </span><span style=color:#0086b3>0 </span><span>{ </span><span style=color:#0086b3>2 </span><span style=font-weight:700;color:#a71d5d>*</span><span> i </span><span style=font-weight:700;color:#a71d5d>+ </span><span style=color:#0086b3>1 </span><span>} </span><span style=font-weight:700;color:#a71d5d>else </span><span>{ </span><span style=font-weight:700;color:#a71d5d>-</span><span style=color:#0086b3>2 </span><span style=font-weight:700;color:#a71d5d>*</span><span> i </span><span style=font-weight:700;color:#a71d5d>- </span><span style=color:#0086b3>1 </span><span>})
</span><span>        .</span><span style=color:#62a35c>map</span><span>(|denominator| Rational::from((</span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>, denominator)))
</span><span>        .</span><span style=color:#62a35c>reduce</span><span>(
</span><span>            || Rational::from((</span><span style=color:#0086b3>0</span><span style=font-weight:700;color:#a71d5d>i64</span><span>, </span><span style=color:#0086b3>1</span><span style=font-weight:700;color:#a71d5d>i64</span><span>)),
</span><span>            |sum: Rational, frac: Rational| sum </span><span style=font-weight:700;color:#a71d5d>+</span><span> frac,
</span><span>        );
</span><span>    println!(</span><span style=color:#183691>"limit:</span><span style=color:#0086b3>{}</span><span style=color:#183691> => </span><span style=color:#0086b3>{}</span><span style=color:#183691>"</span><span>, limit, </span><span style=color:#0086b3>4.0 </span><span style=font-weight:700;color:#a71d5d>*</span><span> result.</span><span style=color:#62a35c>to_f64</span><span>());
</span><span>}
</span></code></pre><div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2022-04-08   Last updated 2021-04-09 </div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#squeak>#Squeak</a></div><div class=navbar-item><a class=tagword href=/tags/#cuis>#Cuis</a></div><div class=navbar-item><a class=tagword href=/tags/#pharo>#Pharo</a></div><div class=navbar-item><a class=tagword href=/tags/#smalltalk>#Smalltalk</a></div><div class=navbar-item><a class=tagword href=/tags/#rust>#Rust</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>