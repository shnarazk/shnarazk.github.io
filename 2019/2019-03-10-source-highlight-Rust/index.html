<!doctype html><html style="has-navbar-fixed-top has-navbar-fixed-bottom" lang=ja><head><meta charset=utf-8><meta viewport="width=device-width, initial-scale=1"><link href="/favicon.ico?refresh=1" rel=icon type=image/x-icon><link href=https://shnarazk.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css rel=stylesheet><link href=/style.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X rel=stylesheet><script crossorigin defer integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-LJ2FmexL77rmGm6SIpxq7y+XA6bkLzGZEgCywzKOZG/ws4va9fUVu2neMjvc3zdv src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/mathtex-script-type.min.js></script><script onload="renderMathInElement(document.body, {
				delimiters: [
					{left: '$$', right: '$$', display: true},
					{left: '$', right: '$', display: false},
					{left: '\\(', right: '\\)', display: false},
					{left: '\\[', right: '\\]', display: true}
				]
			});" crossorigin defer integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener('DOMContentLoaded',()=>{const a=Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'),0);if(a.length>0){a.forEach(b=>{b.addEventListener('click',()=>{const c=b.dataset.target;const d=document.getElementById(c);b.classList.toggle('is-active');d.classList.toggle('is-active')})})}})</script><title>Just a note</title><body><nav aria-label="main navigation" class="navbar is-fixed-top is-light" role=navigation><div class=navbar-brand><div class=navbar-item> <i class="fas fa-book-open has-text-info"></i> <a class=title href=/>Build GNU Source-highlight supporting Rust for NixOS</a></div><a aria-expanded=false aria-label=menu class=navbar-burger data-target=navigation-bar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navigation-bar><div class=navbar-end><div class="navbar-item has-dropdown" id=navigation-dropdown><a onclick="document.getElementById('navigation-dropdown').classList.toggle('is-active')" class=navbar-link></a><div class="navbar-dropdown is-right is-size-5"><a class=navbar-item href=/tags> <i class="fas fa-tags"></i> Tags </a><a class=navbar-item href=/about> <i class="fas fa-question-circle"></i> About </a><a class=navbar-item href=/atom.xml> <i class="fas fa-rss-square"></i>  RSS </a></div></div></div></div></nav><div style=padding-top:3rem><div class=article-container><h1 class="subtitle has-text-info has-text-weight-semibold">NixOS的にlessをRust対応にしよう</h1><p>Let's Rust syntax highlighten in less!<ol><li>We need to apply <a href=https://gist.github.com/tav/3846383>a patch</a>.<li>To apply the patch, make a simple overlay(~/.config/nixpkgs/overlays/source-highlight.nix) against <a href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/tools/text/source-highlight/default.nix>the expression</a> in the master branch.<li>But somehow I failed to build it due to lack of makeinfo.<li>So add super.texinfo to the <code>BuildInputs</code> in the overlay.<li>Run <code>nix-env -i source-highliht</code> and got it.<li>Activate this feature with the following settings:</ol><pre class=language-bash data-lang=bash style=background:#fff;color:#323232><code class=language-bash data-lang=bash><span style=font-weight:700;color:#a71d5d>export </span><span>LESS</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>'-R'
</span><span style=font-weight:700;color:#a71d5d>export </span><span>LESSOPEN</span><span style=font-weight:700;color:#a71d5d>=</span><span style=color:#183691>'|| ~/.nix-profile/bin/src-hilite-lesspipe.sh %s'
</span></code></pre><p>The double veritical bars are important!<blockquote><p>However, if the first character of LESSOPEN starts with two vertical bars, the exit status of the script becomes meaningful. If the exit status is zero, the output is considered to be replacement text, even if it empty. If the exit status is nonzero, any output is ignored and the original file is used. For compatibility with previous versions of less, if LESSOPEN starts with only one vertical bar, the exit status of the preprocessor is ignored.</blockquote><p>In most cases in which <code>less</code> is used as a pager, this settings is identital to the original behavior. On the other side, with a single bar, <code>less</code> clears the sceen to switch to full screen mode.<h3 id=files>files</h3><ul><li>~/.config/nixpkgs/overlays/source-highlight.nix</ul><pre class=language-nix data-lang=nix style=background:#fff;color:#323232><code class=language-nix data-lang=nix><span>self: super:
</span><span>{
</span><span>    </span><span style=color:#795da3>sourceHighlight </span><span style=font-weight:700;color:#a71d5d>= </span><span>super</span><span style=font-weight:700;color:#a71d5d>.</span><span>sourceHighlight</span><span style=font-weight:700;color:#a71d5d>.</span><span>overrideAttrs (attrs: {
</span><span>        </span><span style=color:#795da3>buildInputs </span><span style=font-weight:700;color:#a71d5d>= </span><span>[ super</span><span style=font-weight:700;color:#a71d5d>.</span><span>boost super</span><span style=font-weight:700;color:#a71d5d>.</span><span>texinfo ];
</span><span>        </span><span style=color:#795da3>patches </span><span style=font-weight:700;color:#a71d5d>= </span><span>[ </span><span style=color:#183691>~/.config/nixpkgs/rust.patch </span><span>];
</span><span>    });
</span><span>}
</span></code></pre><ul><li>~/.config/nixpkgs/rust.patch</ul><pre class=language-diff data-lang=diff style=background:#fff;color:#323232><code class=language-diff data-lang=diff><span>diff -urN source-highlight-3.1.8/src/Makefile.am source-highlight-3.1.8-Rust/src/Makefile.am
</span><span style=background:#ffecec;font-weight:700;font-style:italic;color:#bd2c00>---</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8/src/Makefile.am      2015-03-30 22:00:00.000000000 +0900
</span><span style=background:#eaffea;font-weight:700;font-style:italic;color:#55a532>+++</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8-Rust/src/Makefile.am 2019-03-10 21:38:57.249427742 +0900
</span><span style=font-weight:700;font-style:italic;color:#969896>@@ -86,7 +86,7 @@
</span><span> errors.lang erlang.lang proto.lang vala.lang lisp.lang islisp.lang \
</span><span> scheme.lang po.lang opa.lang javalog.lang upc.lang tml.lang \
</span><span> lilypond.lang coffeescript.lang go.lang \
</span><span style=background:#ffecec;color:#323232>-r.lang s.lang zsh.lang groovy.lang json.lang feature.lang
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>r.lang s.lang zsh.lang groovy.lang json.lang feature.lang rust.lang
</span><span> 
</span><span> LANGFILES_NOTTOCHECK= \
</span><span> tml_formatting_all.lang  tml_macrolinks.lang      tml_macrosdelayed2.lang \
</span><span>diff -urN source-highlight-3.1.8/src/Makefile.in source-highlight-3.1.8-Rust/src/Makefile.in
</span><span style=background:#ffecec;font-weight:700;font-style:italic;color:#bd2c00>---</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8/src/Makefile.in      2015-03-31 00:04:55.000000000 +0900
</span><span style=background:#eaffea;font-weight:700;font-style:italic;color:#55a532>+++</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8-Rust/src/Makefile.in 2019-03-10 21:39:16.152740165 +0900
</span><span style=font-weight:700;font-style:italic;color:#969896>@@ -838,7 +838,7 @@
</span><span> errors.lang erlang.lang proto.lang vala.lang lisp.lang islisp.lang \
</span><span> scheme.lang po.lang opa.lang javalog.lang upc.lang tml.lang \
</span><span> lilypond.lang coffeescript.lang go.lang \
</span><span style=background:#ffecec;color:#323232>-r.lang s.lang zsh.lang groovy.lang json.lang feature.lang
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>r.lang s.lang zsh.lang groovy.lang json.lang feature.lang rust.lang
</span><span> 
</span><span> LANGFILES_NOTTOCHECK = \
</span><span> tml_formatting_all.lang  tml_macrolinks.lang      tml_macrosdelayed2.lang \
</span><span>diff -urN source-highlight-3.1.8/src/lang.map source-highlight-3.1.8-Rust/src/lang.map
</span><span style=background:#ffecec;font-weight:700;font-style:italic;color:#bd2c00>---</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8/src/lang.map 2015-03-30 20:26:24.000000000 +0900
</span><span style=background:#eaffea;font-weight:700;font-style:italic;color:#55a532>+++</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8-Rust/src/lang.map    2019-03-10 22:19:59.609966381 +0900
</span><span style=font-weight:700;font-style:italic;color:#969896>@@ -169,3 +169,5 @@
</span><span> groovy = groovy.lang
</span><span> json = json.lang
</span><span> feature = feature.lang
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>rust = rust.lang
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>rs = rust.lang
</span><span>diff -urN source-highlight-3.1.8/src/rust.lang source-highlight-3.1.8-Rust/src/rust.lang
</span><span style=background:#ffecec;font-weight:700;font-style:italic;color:#bd2c00>---</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8/src/rust.lang        1970-01-01 09:00:00.000000000 +0900
</span><span style=background:#eaffea;font-weight:700;font-style:italic;color:#55a532>+++</span><span style=font-style:italic;color:#969896> source-highlight-3.1.8-Rust/src/rust.lang   2019-03-10 13:09:20.711181631 +0900
</span><span style=font-weight:700;font-style:italic;color:#969896>@@ -0,0 +1,18 @@
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>preproc = "import","package"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>include "c_comment.lang"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>include "number.lang"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>string delim "\"" "\"" escape "\\"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>string delim "'" "'"  escape "\\"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>string delim "`" "`"  escape "\\" multiline
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>keyword = "as|assert|break|const|copy|do|drop|else|enum|export|extern|fail|false|fn|for|if|impl|let|log|loop|match|mod|move|mut|p
</span><span>riv|pub|pure|ref|return|struct|true|trait|type|unsafe|use|while"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>keyword = "be|self|static|export|assert|log|fail"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>type = "bool|char|f32|f64|float|i8|i16|i32|i64|int|str|u8|u16|u32|u64|uint"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>include "symbols.lang"
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+
</span><span style=background:#eaffea;font-weight:700;color:#55a532>+</span><span style=background:#eaffea;color:#323232>cbracket = "{|}"
</span></code></pre><div class="date-footer is-size-7 is-family-code has-text-grey has-text-right" style=margin-top:2rem>Published at 2019-03-10</div></div><nav class="navbar is-fixed-bottom" aria-label=navigation id=bottombar><div class=navbar-brand><div class=navbar-item><a class=tagword href=/tags/#rust>#Rust</a></div><div class=navbar-item><a class=tagword href=/tags/#nixos>#NixOS</a></div></div></nav><footer class="copyright is-size-6 has-text-info">Copyright 2019-2023 Narazaki Shuji.</footer>