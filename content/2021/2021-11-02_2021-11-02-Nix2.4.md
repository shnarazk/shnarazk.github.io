---
title: Nix 2.4 released
updated: 2021-11-05
extra:
  banner: /2021/2021-11-02_banner.jpg
  subtitle: experimental-features = nix-command flakes
taxonomies:
    tags: ["NixOS"]
---

- [Announcement on Nix discourse](https://discourse.nixos.org/t/nix-2-4-released/15822/5)
- [Manual (for version 2.4)](https://nixos.org/manual/nix/stable/)

だんだんわかってきたので箇条書きに変更した。

### パッケージの更新

```
nix profile upgrade '.*'
```
flakeはTTLが切れたら勝手に更新してくれる。

ただし、こうしたいならchannelからではなくflakeからパッケージをインストールしなければならない。
以下はnixpkgs-unstable channelからnixpkgs/nixpkgs-unstable registryへ引越しの途中の状態。

```
0 - - /nix/store/l1nnjj26j4nfggzfdp25d5074m35xrwa-parallel-20210722
4 - - /nix/store/6kaig6yyxm6mfha5b21x827dkfazb0cg-ispell-3.4.04
7 - - /nix/store/ghshklfk3q98cikad1wf8b0rpwhmp1iz-tmux-3.2a
8 - - /nix/store/475pa4h5rd6289zm8iga507ppl3k9zwn-nix-2.4pre-rc1
5 - - /nix/store/wiqcjg66s7sb6cais8pifrk3l9cpkrmq-nss-cacert-3.66
7 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.tmux github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.tmux /nix/store/ghshklfk3q98cikad1wf8b0rpwhmp1iz-tmux-3.2a
11 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.ispell github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.ispell /nix/store/6kaig6yyxm6mfha5b21x827dkfazb0cg-ispell-3.4.04
14 flake:nixpkgs/nixpkgs-unstable#legacyPackages.x86_64-darwin.parallel github:NixOS/nixpkgs/7053541084bf5ce2921ef307e5585d39d7ba8b3f#legacyPackages.x86_64-darwin.parallel /nix/store/l1nnjj26j4nfggzfdp25d5074m35xrwa-parallel-20210722
```

この状態からどうやってnixを移行すればいいのだろう。
`nix`と`nix_2_4`とが同じ優先度を持っているのでそれを設定して上書き可能な状態にしなければいけないことはわかった。
しかし既にnix-envが使えない状況でどのコマンドを使えばそれができるのだろう。

[issue](https://github.com/NixOS/nix/issues/5473)立っているのでどうもできないようだ。ワハハ。

### パッケージの削除

`nix profile list`で通し番号を調べて`nix profile remove`で指定。

### ゴミの回収

```
nix profile wipe-history --older-than 7d
```

### パッケージの検索

```sh
nix search nixpkgs package-name
nix search nixpkgs/nixpkgs-unstable package-name   # only a specified branch
```

flakeはキャッシュされるので`nix-env -qa`とは比べ物にならない。

なんか成熟感と新鮮さが同時にやってきた。

----

![](/2021/2021-11-02_banner-2.jpg)

# flake.nixを作って自分のパッケージをインストールする

```
nix build
nix profile install result/
```

一方、channelに対するoverlayはなくなった（はず）なので、さて勝手に最新バージョンをbuildするにはどうしたものか。

例えば、emacs27に対するoverlayだったemacs-headは以下のようにしてemacs28というattributeを注入していた。

```nix
# emacs-head.nix
self: super: {
  emacs28 = super.emacs.overrideAttrs (attrs: rec {
    pname = "emacs-head";
    name = "emacs-head-${version}";
    version = "28.0.60";
```

flakeにするとderivationを一つ返すファイルflake.nixが必要になる。
なのでemacs28が追加された集合を作るのでははなく、できたderivationをそのまま返せばいい(`defaultPackage.${system}`に代入している)。

```nix
# flake.nix
{
  description = "Emacs Head, the unreleased 28.0";
  inputs.nixpkgs.url = github:NixOS/nixpkgs/nixpkgs-unstable;
  inputs.flake-utils.url = "github:numtide/flake-utils";
  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system: {
      defaultPackage =
        with import nixpkgs { system = "x86_64-darwin"; };
        emacs27.overrideAttrs (attrs: rec {
          name = "emacs-head-${version}";
          pname = "emacs-head";
          version = "28.0.60";
```

- ファイル名がflake.nix固定なので、インストールしたいパッケージごとにディレクトリを作らないといけない。
flakesリポジトリのサブディレクトリとしてまとめたいのだが。なんかうまくいかない。
- `nix profile install`でのインストールがうまくいかない。そのためにはできたderivationを`nixpkgs.defaultPackegs` に注入しないといけないのだが見ればわかるようにやってない。それはflake.nixではなくdefault.nixだかshell.nixの仕事のような気がする。`nix build & nix install result/`はうまくいく。
