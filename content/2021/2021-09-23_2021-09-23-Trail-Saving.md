---
title: Trail Saving instead of Chrono-BT
extra:
  banner: /2021/2021-09-23_banner.jpg
  banner_caption: Let's recycle!
  subtitle: I gave it up.
taxonomies:
    tags: ["SAT", "splr", "chronoBT", "trail-saving"]
---
Chrono-BTがちゃんと動かない！
諦めてもっと新しいアプローチに乗り換える！

```rust
fn backtrack(&mut self, bt_level: DecisionLevel) {
  let current_level = self.decision_level();

  for l in self.trail[self.len_upto(bt_level + 1)..self.len_upto(current_level - 1)] {
    let vi = l.vi()
    // copy the reason
    self.reason_saved[vi] = self.reason[vi];
    // save the assign
    self.trail_saved[vi] = self.trail[vi];
  }
  // run the original prodecedure to truncate trail.
}
```

```rust
fn new_propagate(&mut self, mut ix: usize) -> Option<ConflictContext> {
    for i in ix..self.trail.len() {
       if let cc@Some(_clause) = self.use_saved_trail() {
           return cc;
       }
       let propagating_literal = self.trail[i];
       // TODO
       for each clause c in watchlist(!l) {
           if c is unit implying x {
               T.addToEnd(x);
               reason(x) = c;
           } else if c is falsified {
               return Some(ConflictContext(..));
           } else {
               update c's watches.
           }
       }
    }
    None
}
```

```rust
fn use_saved_trail(&mut self) -> Option<ConflictContext> {
    for i in 0..self.tail.len() {
      // TODO
      lsave = Tsave[idx];
      if reasonsave(lsave) == empty {
          if lsave in T {
              continue;
          } else {
              break;
          }
      } else {
          if lsave in T {
              continue;
          } else if !lsave in T {
              c = reasonsave(lsave);
              idx = 0;
              break;
          } else {
              T.addToEnd(lsave);
              reason(lsave) = reason_save(lsave);
          }
      }
    }
    for i in 0..idx {
        Tsave.removeFront();
    }
    None
}
```
